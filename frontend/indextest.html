<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãŠæ•£æ­©++ è¦³å…‰ã‚¬ã‚¤ãƒ‰ä»˜ããƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }

    .ctrl {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 900;
      display: flex;
      gap: 10px;
    }

    .ctrl button {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .popup img {
      width: 250px;
      border-radius: 8px;
      margin-top: 6px;
    }
  </style>
</head>

<body>

  <div class="ctrl">
    <button id="startBtn">é–‹å§‹åœ°ç‚¹</button>
    <button id="wayBtn">çµŒç”±åœ°ç‚¹</button>
    <button id="goalBtn">çµ‚äº†åœ°ç‚¹</button>
    <button id="clearBtn">å…¨éƒ¨å‰Šé™¤</button>
  </div>

  <div id="map"></div>

  <script>
    // ==========================
    // åœ°å›³åˆæœŸåŒ–
    // ==========================
    const map = L.map("map").setView([35.681236, 139.767125], 14);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    // ==========================
    // çŠ¶æ…‹ç®¡ç†
    // ==========================
    let mode = null;
    let startMarker = null;
    let goalMarker = null;
    let wayMarkers = [];
    let routeLine = null;

    let poiMarkers = [];
    let shownPOIs = new Set();

    // ==========================
    // ãƒœã‚¿ãƒ³
    // ==========================
    document.getElementById("startBtn").onclick = () => mode = "start";
    document.getElementById("wayBtn").onclick = () => mode = "way";
    document.getElementById("goalBtn").onclick = () => mode = "goal";

    document.getElementById("clearBtn").onclick = () => {
      if (startMarker) map.removeLayer(startMarker);
      if (goalMarker) map.removeLayer(goalMarker);
      wayMarkers.forEach(m => map.removeLayer(m));
      poiMarkers.forEach(m => map.removeLayer(m));

      wayMarkers = [];
      poiMarkers = [];
      shownPOIs.clear();

      startMarker = null;
      goalMarker = null;

      if (routeLine) map.removeLayer(routeLine);
    };

    // ==========================
    // åœ°å›³ã‚¯ãƒªãƒƒã‚¯
    // ==========================
    map.on("click", (e) => {
      if (!mode) return;

      if (mode === "start") {
        if (startMarker) map.removeLayer(startMarker);
        startMarker = L.marker(e.latlng, { icon: redIcon() }).addTo(map);
      }

      if (mode === "way") {
        const m = L.marker(e.latlng, { icon: blueIcon() }).addTo(map);
        m.on("click", () => {
          map.removeLayer(m);
          wayMarkers = wayMarkers.filter(w => w !== m);
          drawRoute();
        });
        wayMarkers.push(m);
      }

      if (mode === "goal") {
        if (goalMarker) map.removeLayer(goalMarker);
        goalMarker = L.marker(e.latlng, { icon: greenIcon() }).addTo(map);
      }

      drawRoute();
    });

    // ==========================
    // ãƒ«ãƒ¼ãƒˆæç”»ï¼ˆOSRMï¼‰
    // ==========================
    async function drawRoute() {
      if (!startMarker || !goalMarker) return;

      const points = [];

      const s = startMarker.getLatLng();
      points.push(`${s.lng},${s.lat}`);

      wayMarkers.forEach(m => {
        const p = m.getLatLng();
        points.push(`${p.lng},${p.lat}`);
      });

      const g = goalMarker.getLatLng();
      points.push(`${g.lng},${g.lat}`);

      const url =
        `https://router.project-osrm.org/route/v1/foot/` +
        points.join(";") +
        `?overview=full&geometries=geojson`;

      const res = await fetch(url);
      const data = await res.json();
      if (!data.routes) return;

      const coords = data.routes[0].geometry.coordinates.map(
        c => [c[1], c[0]]
      );

      if (routeLine) map.removeLayer(routeLine);
      routeLine = L.polyline(coords, { color: "purple", weight: 4 }).addTo(map);
      map.fitBounds(routeLine.getBounds());

      poiMarkers.forEach(m => map.removeLayer(m));
      poiMarkers = [];
      shownPOIs.clear();

      const sampled = sampleRoute(coords, 30);
      searchPOIs(sampled);
    }

    function sampleRoute(coords, step = 30) {
      return coords.filter((_, i) => i % step === 0);
    }

    // ==========================
    // Overpass API
    // ==========================
    function buildOverpassQuery(points, radius = 50) {
      const q = points.map(p => `
        node(around:${radius},${p[0]},${p[1]})["tourism"];
        node(around:${radius},${p[0]},${p[1]})["historic"];
        node(around:${radius},${p[0]},${p[1]})["leisure"="park"];
      `).join("\n");

      return `
[out:json][timeout:25];
(
${q}
);
out tags center;
`;
    }

    async function searchPOIs(coords) {
      const query = buildOverpassQuery(coords);
      const res = await fetch(
        "https://overpass-api.de/api/interpreter",
        { method: "POST", body: query }
      );
      const data = await res.json();
      showPOIs(data.elements);
    }

    // ==========================
    // è¦³å…‰ã‚¹ãƒãƒƒãƒˆè¡¨ç¤ºï¼ˆè©³ç´°ä»˜ãï¼‰
    // ==========================
    async function showPOIs(elements) {
      for (const el of elements) {
        if (shownPOIs.has(el.id)) continue;
        shownPOIs.add(el.id);

        if (!el.lat || !el.lon) continue;

        const tags = el.tags || {};
        let html = `<div class="popup"><b>${tags.name || "è¦³å…‰ã‚¹ãƒãƒƒãƒˆ"}</b><br>`;

        if (tags.description)
          html += `<p>${tags.description}</p>`;

        if (tags.opening_hours)
          html += `<p>ğŸ•’ ${tags.opening_hours}</p>`;

        if (tags.website)
          html += `<p><a href="${tags.website}" target="_blank">å…¬å¼ã‚µã‚¤ãƒˆ</a></p>`;

        if (tags.wikipedia) {
          const title = tags.wikipedia.split(":")[1];
          html += `<p><a href="https://ja.wikipedia.org/wiki/${title}" target="_blank">Wikipedia</a></p>`;
        }

        if (tags.wikidata) {
          const img = await getImageFromWikidata(tags.wikidata);
          if (img) html += `<img src="${img}">`;
        }

        html += `</div>`;

        const m = L.marker([el.lat, el.lon])
          .addTo(map)
          .bindPopup(html);

        poiMarkers.push(m);
      }
    }

    // ==========================
    // Wikidata â†’ ç”»åƒå–å¾—
    // ==========================
    async function getImageFromWikidata(id) {
      try {
        const url = `https://www.wikidata.org/wiki/Special:EntityData/${id}.json`;
        const res = await fetch(url);
        const data = await res.json();

        const entity = data.entities[id];
        const imageName =
          entity?.claims?.P18?.[0]?.mainsnak?.datavalue?.value;

        if (!imageName) return null;

        return `https://commons.wikimedia.org/wiki/Special:FilePath/${imageName}?width=300`;
      } catch {
        return null;
      }
    }

    // ==========================
    // ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³
    // ==========================
    function redIcon() {
      return new L.Icon({
        iconUrl: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
        iconSize: [32, 32],
      });
    }
    function blueIcon() {
      return new L.Icon({
        iconUrl: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        iconSize: [32, 32],
      });
    }
    function greenIcon() {
      return new L.Icon({
        iconUrl: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
        iconSize: [32, 32],
      });
    }
  </script>

</body>
</html>