<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãŠæ•£æ­©++ ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }

    .ctrl {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      width: 260px;
    }

    .ctrl button {
      margin: 4px 0;
      width: 100%;
      padding: 6px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #f0f0f0;
    }

    .ctrl button:hover {
      background: #e0e0e0;
    }

    #search {
      width: 100%;
      padding: 6px;
      margin-bottom: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .suggest {
      border: 1px solid #ccc;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 13px;
    }

    .suggest div {
      padding: 6px;
      cursor: pointer;
    }

    .suggest div:hover {
      background: #f5f5f5;
    }

    .s-station { border-left: 6px solid #2196f3; }
    .s-shop { border-left: 6px solid #4caf50; }
    .s-tourism { border-left: 6px solid #9c27b0; }
    .s-other { border-left: 6px solid #9e9e9e; }
  </style>
</head>

<body>

<div class="ctrl">
  <input id="search" placeholder="å ´æ‰€ã‚’æ¤œç´¢ï¼ˆé§…ãƒ»åº—ãƒ»è¦³å…‰åœ°ï¼‰" />
  <div id="suggest" class="suggest"></div>

  <button id="startBtn">é–‹å§‹åœ°ç‚¹</button>
  <button id="wayBtn">çµŒç”±åœ°ç‚¹</button>
  <button id="goalBtn">çµ‚äº†åœ°ç‚¹</button>
  <button id="clearBtn">å…¨éƒ¨å‰Šé™¤</button>
</div>

<div id="map"></div>

<script>
  // ==========================
  // åœ°å›³åˆæœŸåŒ–
  // ==========================
  const map = L.map("map").setView([35.681236, 139.767125], 14);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  // ==========================
  // çŠ¶æ…‹
  // ==========================
  let mode = null;
  let startMarker = null;
  let goalMarker = null;
  let wayMarkers = [];
  let routeLine = null;

  // ==========================
  // ãƒœã‚¿ãƒ³
  // ==========================
  startBtn.onclick = () => mode = "start";
  wayBtn.onclick = () => mode = "way";
  goalBtn.onclick = () => mode = "goal";

  clearBtn.onclick = () => {
    if (startMarker) map.removeLayer(startMarker);
    if (goalMarker) map.removeLayer(goalMarker);
    wayMarkers.forEach(m => map.removeLayer(m));
    wayMarkers = [];
    startMarker = null;
    goalMarker = null;
    if (routeLine) map.removeLayer(routeLine);
  };

  // ==========================
  // åœ°å›³ã‚¯ãƒªãƒƒã‚¯
  // ==========================
  map.on("click", e => placeMarker(e.latlng));

  function placeMarker(latlng) {
    if (!mode) return;

    if (mode === "start") {
      if (startMarker) map.removeLayer(startMarker);
      startMarker = L.marker(latlng, { icon: redIcon() }).addTo(map);
    }

    if (mode === "way") {
      const m = L.marker(latlng, { icon: blueIcon() }).addTo(map);
      m.on("click", () => {
        map.removeLayer(m);
        wayMarkers = wayMarkers.filter(w => w !== m);
        drawRoute();
      });
      wayMarkers.push(m);
    }

    if (mode === "goal") {
      if (goalMarker) map.removeLayer(goalMarker);
      goalMarker = L.marker(latlng, { icon: greenIcon() }).addTo(map);
    }

    drawRoute();
  }

  // ==========================
  // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆOSRMï¼‰
  // ==========================
  async function drawRoute() {
    if (!startMarker || !goalMarker) return;

    const points = [];
    const s = startMarker.getLatLng();
    points.push(`${s.lng},${s.lat}`);

    wayMarkers.forEach(m => {
      const p = m.getLatLng();
      points.push(`${p.lng},${p.lat}`);
    });

    const g = goalMarker.getLatLng();
    points.push(`${g.lng},${g.lat}`);

    const url =
      "https://router.project-osrm.org/route/v1/foot/" +
      points.join(";") +
      "?overview=full&geometries=geojson";

    const res = await fetch(url);
    const data = await res.json();
    if (!data.routes) return;

    const coords = data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);

    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(coords, { color: "purple", weight: 4 }).addTo(map);
  }

  // ==========================
  // æ¤œç´¢ï¼‹ã‚µã‚¸ã‚§ã‚¹ãƒˆ
  // ==========================
  const searchBox = document.getElementById("search");
  const suggestBox = document.getElementById("suggest");

  searchBox.oninput = () => {
    const q = searchBox.value;
    if (q.length < 2) {
      suggestBox.innerHTML = "";
      return;
    }
    fetchSuggest(q);
  };

  function classify(item) {
    if (item.class === "railway") return "station";
    if (item.class === "amenity" || item.class === "shop") return "shop";
    if (item.class === "tourism") return "tourism";
    return "other";
  }

  async function fetchSuggest(q) {
    const url =
      `https://nominatim.openstreetmap.org/search?` +
      `q=${encodeURIComponent(q)}&format=json&limit=6`;

    const res = await fetch(url, {
      headers: { "User-Agent": "osanpo-plus" }
    });
    const data = await res.json();

    suggestBox.innerHTML = "";

    data.forEach(item => {
      const type = classify(item);
      const div = document.createElement("div");
      div.className = "s-" + type;

      const label =
        type === "station" ? "ğŸš‰ é§…" :
        type === "shop" ? "ğŸª åº—" :
        type === "tourism" ? "ğŸ› è¦³å…‰" : "ğŸ“ ãã®ä»–";

      div.innerHTML = `<strong>${label}</strong><br>${item.display_name}`;

      div.onclick = () => {
        const latlng = { lat: +item.lat, lng: +item.lon };
        map.setView(latlng, 16);
        placeMarker(latlng);
        suggestBox.innerHTML = "";
        searchBox.value = item.display_name;
      };

      suggestBox.appendChild(div);
    });
  }

  // ==========================
  // ã‚¢ã‚¤ã‚³ãƒ³
  // ==========================
  function redIcon() {
    return new L.Icon({
      iconUrl: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
      iconSize: [32, 32]
    });
  }
  function blueIcon() {
    return new L.Icon({
      iconUrl: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
      iconSize: [32, 32]
    });
  }
  function greenIcon() {
    return new L.Icon({
      iconUrl: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
      iconSize: [32, 32]
    });
  }
</script>

</body>
</html>
