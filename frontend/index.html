<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>お散歩++ 完成版</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="css/style.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

<div class="ctrl">
  <input id="search" placeholder="場所を検索">
  <div id="suggest" class="suggest"></div>

  <button id="startBtn">開始地点</button>
  <button id="wayBtn">経由地点</button>
  <button id="goalBtn">終了地点</button>
  <button id="clearBtn">全部削除</button>

  <div id="info" class="info"></div>
</div>

<div id="map"></div>

<script>
// ==========================
// Map
// ==========================
const map = L.map("map").setView([35.681236, 139.767125], 14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

// ==========================
// State
// ==========================
let mode = null;
let startMarker = null;
let goalMarker = null;
let wayMarkers = [];
let routeLine = null;
let poiMarkers = [];
let shownPOIs = new Set();

// ==========================
// Buttons
// ==========================
startBtn.onclick = () => mode = "start";
wayBtn.onclick   = () => mode = "way";
goalBtn.onclick  = () => mode = "goal";

clearBtn.onclick = () => {
  [startMarker, goalMarker, routeLine].forEach(m => m && map.removeLayer(m));
  wayMarkers.forEach(m => map.removeLayer(m));
  poiMarkers.forEach(m => map.removeLayer(m));

  startMarker = goalMarker = routeLine = null;
  wayMarkers = [];
  poiMarkers = [];
  shownPOIs.clear();
  info.textContent = "";
};

// ==========================
// Click map
// ==========================
map.on("click", e => placeMarker(e.latlng));

function placeMarker(latlng) {
  if (!mode) return;

  if (mode === "start") {
    startMarker && map.removeLayer(startMarker);
    startMarker = L.marker(latlng, { icon: redIcon() }).addTo(map);
  }

  if (mode === "goal") {
    goalMarker && map.removeLayer(goalMarker);
    goalMarker = L.marker(latlng, { icon: greenIcon() }).addTo(map);
  }

  if (mode === "way") {
    addWayMarker(latlng);
  }

  drawRoute();
}

function addWayMarker(latlng) {
  const m = L.marker(latlng, { icon: blueIcon() }).addTo(map);
  m.on("click", () => {
    map.removeLayer(m);
    wayMarkers = wayMarkers.filter(w => w !== m);
    drawRoute();
  });
  wayMarkers.push(m);
}

// ==========================
// Routing (OSRM)
// ==========================
async function drawRoute() {
  if (!startMarker || !goalMarker) return;

  const points = [
    startMarker.getLatLng(),
    ...wayMarkers.map(m => m.getLatLng()),
    goalMarker.getLatLng()
  ];

  const url =
    `https://router.project-osrm.org/route/v1/foot/` +
    points.map(p => `${p.lng},${p.lat}`).join(";") +
    `?overview=full&geometries=geojson`;

  const res = await fetch(url);
  const data = await res.json();
  if (!data.routes) return;

  const route = data.routes[0];
  const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);

  routeLine && map.removeLayer(routeLine);
  routeLine = L.polyline(coords, { color: "purple", weight: 4 }).addTo(map);

  const km = (route.distance / 1000).toFixed(2);
  const min = Math.round(route.duration / 60);
  info.textContent = `距離 ${km} km / 約 ${min} 分`;

  updatePOIs(coords);
}

// ==========================
// POI search (Overpass)
// ==========================
function buildQuery(points) {
  return `
[out:json][timeout:25];
(
${points.map(p => `
  node(around:60,${p[0]},${p[1]})["tourism"];
  node(around:60,${p[0]},${p[1]})["historic"];
  node(around:60,${p[0]},${p[1]})["leisure"="park"];
`).join("")}
);
out tags center;
`;
}

async function updatePOIs(coords) {
  poiMarkers.forEach(m => map.removeLayer(m));
  poiMarkers = [];
  shownPOIs.clear();

  const sampled = coords.filter((_, i) => i % 30 === 0);
  const res = await fetch("https://overpass-api.de/api/interpreter", {
    method: "POST",
    body: buildQuery(sampled)
  });
  const data = await res.json();

  data.elements.forEach(el => {
    if (!el.lat || !el.lon || shownPOIs.has(el.id)) return;
    if (!el.tags?.name) return;

    shownPOIs.add(el.id);

    const icon = poiIcon(el.tags);
    const m = L.marker([el.lat, el.lon], { icon }).addTo(map)
      .bindPopup(`<b>${el.tags.name}</b><br>${el.tags.tourism || el.tags.historic || "park"}`);

    // ★ ダブルクリックで経由地点に
    m.on("dblclick", () => {
      addWayMarker({ lat: el.lat, lng: el.lon });
      drawRoute();
    });

    poiMarkers.push(m);
  });
}

// ==========================
// Search (Nominatim)
// ==========================
search.oninput = async () => {
  if (search.value.length < 2) {
    suggest.innerHTML = "";
    return;
  }

  const res = await fetch(
    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(search.value)}&format=json&limit=6`,
    { headers: { "User-Agent": "osanpo-plus" } }
  );
  const data = await res.json();
  suggest.innerHTML = "";

  data.forEach(item => {
    const div = document.createElement("div");
    div.textContent = item.display_name;
    div.onclick = () => {
      placeMarker({ lat: +item.lat, lng: +item.lon });
      map.setView([item.lat, item.lon], 16);
      suggest.innerHTML = "";
      search.value = item.display_name;
    };
    suggest.appendChild(div);
  });
};

// ==========================
// Icons
// ==========================
const icon = color => new L.Icon({
  iconUrl: `https://maps.google.com/mapfiles/ms/icons/${color}-dot.png`,
  iconSize: [32, 32]
});

const redIcon   = () => icon("red");
const blueIcon  = () => icon("blue");
const greenIcon = () => icon("green");

function poiIcon(tags) {
  if (tags.tourism) return icon("purple");
  if (tags.historic) return icon("yellow");
  if (tags.leisure === "park") return icon("green");
  return icon("orange");
}
</script>

</body>
</html>
